(function($){var listCounter=0;function filterNodes(ns,test){for(var i=0,r=[];i<ns.length;i++){if(test(ns[i])){r.push(ns[i])}}return r}function List(elem,dataRef,opts){this.elem=elem;switch(elem.tagName){case"TABLE":this.getRows=function(){return this.elem.rows};break;case"UL":case"OL":this.getRows=function(){return filterNodes(this.elem.childNodes,function(n){return n.tagName=="LI"})};break;default:this.getRows=function(){return filterNodes(this.elem.childNodes,function(n){return n.nodeType==1})}}opts=$.extend(opts,{viewSelector:".nub-list-view"});this.filterRef=$.nub.path(dataRef).inContext("nub:listFilters");$.nub.filter(this.filterRef,dataRef,function(data,args){data=$.isArray(data)?data:[];var lastPage=Math.ceil(data.length/args.pageSize);if(lastPage==0){lastPage=1}if(args.page>lastPage){args.page=lastPage}var offset=args.pageSize*(args.page-1);return{lastPage:lastPage,pageRows:data.slice(offset,offset+args.pageSize)}});$.nub.set("filter:args",{page:1,pageSize:opts.rowCount},this.filterRef);var list=this;var $list=$(elem);var rowsRef=$.nub.path("pageRows",this.filterRef);var $row=$(".nub-list-row:first",elem).addClass("nub-context");$row.attr("data",$.nub.path("0",rowsRef).toString());$row.remove();var offset=this.getRows().length;$.nub.view("filter:args/pageSize",function(){var rowCount=$.nub.get("filter:args/pageSize",list.filterRef)+offset;var rows=list.getRows();if(rows.length<rowCount){for(var i=rows.length;i<rowCount;i++){var cx=$.nub.path((i-offset).toString(),rowsRef).toString();var $tr=$row.clone().attr("data",cx);$list.append($tr);$.nub.init($tr,opts);if(opts.click||opts.selectCSS){$tr.click(function(){var $tr=$(this);if(list.selected&&opts.selectCSS){list.selected.removeClass(opts.selectCSS)}list.selected=$tr;if(opts.selectCSS){list.selected.addClass(opts.selectCSS)}if(opts.click){opts.click($tr)}})}if(opts.hoverCSS){$tr.hover(function(){$(this).addClass(opts.hoverCSS)},function(){$(this).removeClass(opts.hoverCSS)})}}}else{for(var i=rowCount;i<rows.length;i++){$(rows[i]).remove()}}},this.filterRef);if($.isFunction(opts.onpage)){$.nub.view("filter:args/page",function(){opts.onpage.apply(list,[$.nub.get(list.filterRef)])},this.filterRef)}if(opts.hideEmptyRows){$.nub.view(this.filterRef,function(){var data=$.nub.get(rowsRef);var len=data?data.length:0;len+=offset;var rows=list.getRows();for(var i=offset;i<rows.length;i++){$(rows[i])[i<len?"show":"hide"]()}})}else{if(opts.emptyRowCSS){$.nub.view(this.filterRef,function(){var data=$.nub.get(rowsRef);var len=data?data.length:0;len+=offset;var rows=list.getRows();for(var i=offset;i<rows.length;i++){if(i<len){$(rows[i]).removeClass(opts.emptyRowCSS)}else{$(rows[i]).addClass(opts.emptyRowCSS)}}})}}}List.prototype.getPageSize=function(){return $.nub.get("filter:args/pageSize",this.filterRef)};List.prototype.setPageSize=function(pageSize){if(pageSize<1){pageSize=1}$.nub.set("filter:args/pageSize",pageSize,this.filterRef)};var pagerIconClickFns={first:function(filterRef){return function(){$.nub.set("filter:args/page",1,filterRef)}},prev:function(filterRef){return function(){var page=$.nub.get("filter:args/page",filterRef);if(page>1){$.nub.set("filter:args/page",page-1,filterRef)}}},next:function(filterRef){return function(){var data=$.nub.get(filterRef);var page=$.nub.get("filter:args/page",filterRef);if(page<data.lastPage){$.nub.set("filter:args/page",page+1,filterRef)}}},last:function(filterRef){return function(){$.nub.set("filter:args/page",$.nub.get("lastPage",filterRef),filterRef)}}};function makePagerIcon(parent,id,filterRef,opts){var icon=document.createElement("img");icon.src="images/"+id+".png";icon.alt=icon.title=opts.pagingTitles[id];var $icon=$(parent).append(icon);$icon.addClass("nub-list-footer-"+id).click(pagerIconClickFns[id](filterRef));return $icon}function makePager(list,opts){var $container=$('<div class="nub-list-footer">');var $form=$("<form>");var first=pagerIconClickFns.first(list.filterRef);var prev=pagerIconClickFns.prev(list.filterRef);var next=pagerIconClickFns.next(list.filterRef);var last=pagerIconClickFns.last(list.filterRef);var $page=$("<span>").append($("<input>").attr("size","2").each(function(){var $this=$(this);$.nub.view("filter:args/page",function(){$this.val($.nub.get("filter:args/page",list.filterRef))},list.filterRef)}).change(function(){var page=Number($(this).val());if(page!=Number.NaN){$.nub.set("filter:args/page",page,list.filterRef)}else{$(this).val($.nub.get("filter:args/page",list.filterRef))}})).append(document.createTextNode(" / "));var $count=$("<span>");$.nub.view("lastPage",$count[0],list.filterRef);$page.append($count);$form.append(opts.layoutPager(first,prev,$page,next,last));return list.elem.parentNode.insertBefore($container.append($form)[0],list.elem.nextSibling)}$.fn.nubList=function(opts){if(typeof(opts)=="string"){switch(opts){case"list":return $(this).first().data("nub-list")}}else{opts=$.extend({},{rowCount:20,hideEmptyRows:true,emptyRowCSS:"nub-list-empty-row",pager:true,layoutPager:function(first,prev,$page,next,last){return $("<ul>").append($("<li>").append("<a>First</a>").click(first)).append($("<li>").append("<a>Previous</a>").click(prev)).append($("<li>").append($page)).append($("<li>").append("<a>Next</a>").click(next)).append($("<li>").append("<a>Last</a>").click(last))},oninit:function(list){}},opts);var lists=[];$(this).each(function(){if($.metadata!==undefined){opts=$.extend({},opts,$.metadata.get(this))}var dataRef=$(this).attr("data");var list=new List(this,dataRef,opts);if(opts.pager){list.pager=makePager(list,opts)}opts.oninit(list.elem,list.pager);lists.push(list);$(this).data("nub-list",list)});return lists.length>1?lists:lists[0]}}})(jQuery);